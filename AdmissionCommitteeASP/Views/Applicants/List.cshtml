@using System.ComponentModel.DataAnnotations
@using static System.Reflection.CustomAttributeExtensions
@model IEnumerable<Applicant>
@{
    ViewData["Title"] = "Список абитуриентов";
}

<table class="table table-bordered">
    <thead>
    <tr>
        <th>Имя</th>
        <th>Фамилия</th>
        <th>Отчество</th>
        <th>Дата рождения</th>
        <th>Форма обучения</th>
        <th>Пол</th>
        <th>Баллы по математике</th>
        <th>Баллы по русскому</th>
        <th>Баллы по информатике</th>
        <th>Сумма баллов</th>
    </tr>
    </thead>
    <tbody>
    <div id="MoreThanMinScoreCount">
        Кол-во абитуриентов с баллами >=
    </div>
    @{
        var count = 0;
        foreach (var applicant in Model)
        {
            var moreThanMinScore = applicant.TotalScore >= ApplicantConstraints.MinScore;
            if (moreThanMinScore)
            {
                count++;
            }

            <tr @(moreThanMinScore ? "class=table-success" : "")>
                <td>@applicant.Name</td>
                <td>@applicant.Surname</td>
                <td>@applicant.Patronymic</td>
                <td>@applicant.BirthDay.ToShortDateString()</td>
                <td>@(GetMemberDisplayName<FormOfEducation>(applicant.FormOfEducation.ToString()))</td>
                <td>@(GetMemberDisplayName<Gender>(applicant.Gender.ToString()))</td>
                <td>@applicant.MathScore</td>
                <td>@applicant.RussianScore</td>
                <td>@applicant.ItScore</td>
                <td>@applicant.TotalScore</td>
            </tr>
        }
    }
    <script>
        document.getElementById("MoreThanMinScoreCount").innerText += " @count"
    </script>
    </tbody>
</table>

@functions
{
    public static string GetMemberDisplayName<T>(string memberName)
    {
        var member = typeof(T).GetMember(memberName).FirstOrDefault() ?? throw new NullReferenceException();
        var attributes = member
            .GetCustomAttributes(typeof(DisplayAttribute))
            .Cast<DisplayAttribute>()
            .ToList();
        foreach (var attribute in attributes)
        {
            if (attribute.Name != null)
            {
                return attribute.Name;
            }
        }

        throw new InvalidOperationException(!attributes.Any() ? "У значения нет атрибута Display" : "У атрибута Display не задано свойство Name");
    }
}
